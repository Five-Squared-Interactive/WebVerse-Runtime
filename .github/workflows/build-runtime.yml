name: Build WebVerse Runtime

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows Desktop'
        type: boolean
        default: true
      build_mac:
        description: 'Build Mac Desktop'
        type: boolean
        default: true
      build_webgl_compressed:
        description: 'Build WebGL Compressed'
        type: boolean
        default: true
      build_webgl_uncompressed:
        description: 'Build WebGL Uncompressed'
        type: boolean
        default: true

env:
  UNITY_VERSION: "6000.0.58f2"
  S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
  AWS_REGION: us-east-1

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      build_id: ${{ steps.metadata.outputs.build_id }}
      short_sha: ${{ steps.metadata.outputs.short_sha }}
      build_date: ${{ steps.metadata.outputs.build_date }}
    steps:
      - name: Generate build metadata
        id: metadata
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          BUILD_ID="${BUILD_DATE}_${SHORT_SHA}"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

  # Windows Desktop build
  build-windows-desktop:
    needs: prepare
    runs-on: [self-hosted, Windows, unity]
    timeout-minutes: 720
    if: ${{ github.event_name == 'push' || github.event.inputs.build_windows == 'true' }}
    env:
      BUILD_ID: ${{ needs.prepare.outputs.build_id }}
      PROJECT_PATH: ${{ github.workspace }}
      UNITY_PATH: ${{ vars.UNITY_WINDOWS_PATH || 'C:\Program Files\Unity\Hub\Editor\6000.0.58f2\Editor\Unity.exe' }}
      UNITY_ASSETS_PATH: ${{ vars.UNITY_ASSETS_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Assets' }}
      UNITY_PACKAGES_PATH: ${{ vars.UNITY_PACKAGES_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Packages' }}
      LOCALAPPDATA: ${{ github.workspace }}\.unity-cache\LocalAppData
      APPDATA: ${{ github.workspace }}\.unity-cache\AppData

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Restore Library cache
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $cacheLocation) {
            Write-Host "Restoring Library cache from: $cacheLocation"
            if (Test-Path $libraryPath) { Remove-Item -Recurse -Force $libraryPath }
            Copy-Item -Path $cacheLocation -Destination $libraryPath -Recurse -Force
            Write-Host "Cache last modified: $((Get-Item $cacheLocation).LastWriteTime)"
          } else {
            Write-Host "No Library cache found. First build will be slower."
          }

      - name: Setup Unity cache directories
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheDir = "${{ github.workspace }}\.unity-cache"
          New-Item -ItemType Directory -Path "$cacheDir\LocalAppData\Unity\Caches" -Force | Out-Null
          New-Item -ItemType Directory -Path "$cacheDir\AppData\Unity" -Force | Out-Null

      - name: Setup Unity packages (Assets)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $assetsPath = "$env:UNITY_ASSETS_PATH"
          if (-not (Test-Path "$env:PROJECT_PATH\Assets")) { Write-Host "::error::Project Assets not found"; exit 1 }
          if (-not (Test-Path $assetsPath)) { Write-Host "::error::Unity assets not found at $assetsPath"; exit 1 }
          
          $packages = @(
            @{ Name = "Digger"; RelPath = "Digger" },
            @{ Name = "Samples"; RelPath = "Samples" },
            @{ Name = "NWH"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH" },
            @{ Name = "Silantro"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro" },
            @{ Name = "URPWater"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater" }
          )
          
          foreach ($pkg in $packages) {
            $sourcePath = Join-Path $assetsPath $pkg.RelPath
            $targetPath = Join-Path "$env:PROJECT_PATH\Assets" $pkg.RelPath
            if (Test-Path $sourcePath) {
              $targetParent = Split-Path $targetPath -Parent
              if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              if (Test-Path "$sourcePath.meta") { Copy-Item -Path "$sourcePath.meta" -Destination "$targetPath.meta" -Force }
              Write-Host "Copied $($pkg.Name)"
            }
          }

      - name: Setup Vuplex Desktop
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $vuplexSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex-Desktop"
          $vuplexTarget = "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex"
          if (Test-Path $vuplexSource) {
            $targetParent = Split-Path $vuplexTarget -Parent
            if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
            if (Test-Path $vuplexTarget) { Remove-Item -Recurse -Force $vuplexTarget }
            if (Test-Path "$vuplexTarget.meta") { Remove-Item -Force "$vuplexTarget.meta" }
            New-Item -ItemType Directory -Path $vuplexTarget -Force | Out-Null
            Copy-Item -Path "$vuplexSource\*" -Destination $vuplexTarget -Recurse -Force
            $metaSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta"
            if (Test-Path $metaSource) { Copy-Item -Path $metaSource -Destination "$vuplexTarget.meta" -Force }
            Write-Host "Copied Vuplex Desktop"
          } else { Write-Host "::error::Vuplex Desktop not found"; exit 1 }

      - name: Setup Unity packages (Embedded)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $packagesPath = "$env:UNITY_PACKAGES_PATH"
          if (-not (Test-Path $packagesPath)) { Write-Host "::error::Packages not found"; exit 1 }
          $embeddedPackages = @("com.occasoftware.super-simple-skybox", "com.tivadar.best.http", "com.tivadar.best.mqtt", "com.tivadar.best.websockets")
          foreach ($pkg in $embeddedPackages) {
            $sourcePath = Join-Path $packagesPath $pkg
            $targetPath = Join-Path "$env:PROJECT_PATH\Packages" $pkg
            if (Test-Path $sourcePath) {
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              Write-Host "Copied $pkg"
            }
          }

      - name: Create Logs directory
        shell: powershell -ExecutionPolicy Bypass {0}
        run: New-Item -ItemType Directory -Path "$env:PROJECT_PATH\Logs" -Force | Out-Null

      - name: Resolve Unity packages
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $logFile = "$env:PROJECT_PATH\Logs\package-resolve.log"
          $process = Start-Process -FilePath $env:UNITY_PATH -ArgumentList @("-batchmode", "-nographics", "-quit", "-projectPath", "$env:PROJECT_PATH", "-logFile", $logFile) -Wait -PassThru -NoNewWindow
          if (Test-Path $logFile) { Select-String -Path $logFile -Pattern "error CS|error:" | ForEach-Object { Write-Host $_.Line } }
          if ($process.ExitCode -ne 0) { Write-Host "::error::Package resolve failed"; exit $process.ExitCode }

      - name: Build Windows Desktop
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $buildStart = Get-Date
          $logFile = "$env:PROJECT_PATH\Logs\build-windows.log"
          $process = Start-Process -FilePath $env:UNITY_PATH -ArgumentList @("-batchmode", "-nographics", "-quit", "-projectPath", "$env:PROJECT_PATH", "-executeMethod", "FiveSQD.WebVerse.Building.Builder.BuildWindowsDesktop", "-logFile", $logFile) -Wait -PassThru -NoNewWindow
          Write-Host "Build duration: $((Get-Date) - $buildStart)"
          if (Test-Path $logFile) { Get-Content $logFile -Tail 50 }
          if ($process.ExitCode -ne 0) { Write-Host "::error::Build failed"; exit $process.ExitCode }

      - name: Create archive
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $artifactsDir = "$env:PROJECT_PATH\Artifacts"
          New-Item -ItemType Directory -Path $artifactsDir -Force | Out-Null
          $excludeFolders = @("*_BackUpThisFolder_ButDontShipItWithYourGame", "*_BurstDebugInformation_DoNotShip")
          if (Test-Path "$env:PROJECT_PATH\Builds\Windows-Desktop") {
            foreach ($pattern in $excludeFolders) {
              Get-ChildItem "$env:PROJECT_PATH\Builds\Windows-Desktop" -Directory -Filter $pattern -Recurse | ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
            }
            Compress-Archive -Path "$env:PROJECT_PATH\Builds\Windows-Desktop\*" -DestinationPath "$artifactsDir\Windows-Desktop-$env:BUILD_ID.zip"
          }

      - name: Upload to S3
        shell: powershell -ExecutionPolicy Bypass {0}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          $awsCli = "C:\Program Files\Amazon\AWSCLIV2\aws.exe"
          if (-not (Test-Path $awsCli)) {
            $awsCli = (Get-Command aws -ErrorAction SilentlyContinue).Source
            if (-not $awsCli) { Write-Host "::error::AWS CLI not found"; exit 1 }
          }
          $s3Path = "s3://$env:S3_BUCKET/builds/$env:BUILD_ID"
          Get-ChildItem "$env:PROJECT_PATH\Artifacts\*.zip" | ForEach-Object {
            & $awsCli s3 cp $_.FullName "$s3Path/$($_.Name)" --region $env:AWS_REGION
            Write-Host "https://$env:S3_BUCKET.s3.$env:AWS_REGION.amazonaws.com/builds/$env:BUILD_ID/$($_.Name)"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-desktop-${{ needs.prepare.outputs.build_id }}
          path: ${{ github.workspace }}/Artifacts/*.zip
          retention-days: 30

      - name: Save Library cache
        if: success()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $libraryPath) {
            if (Test-Path $cacheLocation) { Remove-Item -Recurse -Force $cacheLocation }
            Copy-Item -Path $libraryPath -Destination $cacheLocation -Recurse -Force
            $cacheSize = (Get-ChildItem $cacheLocation -Recurse | Measure-Object -Property Length -Sum).Sum / 1GB
            Write-Host "Library cache saved. Size: $([math]::Round($cacheSize, 2)) GB"
          }

      - name: Cleanup
        if: always()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          Remove-Item -Path "$env:PROJECT_PATH\Builds" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Artifacts" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "${{ github.workspace }}\.unity-cache" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.occasoftware.super-simple-skybox" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.http" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.mqtt" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.websockets" -Recurse -Force -ErrorAction SilentlyContinue

  # WebGL Compressed build (runs after Windows Desktop to benefit from Library cache)
  build-webgl-compressed:
    needs: [prepare, build-windows-desktop]
    if: ${{ always() && (github.event_name == 'push' || github.event.inputs.build_webgl_compressed == 'true') && (needs.build-windows-desktop.result == 'success' || needs.build-windows-desktop.result == 'skipped') }}
    runs-on: [self-hosted, Windows, unity]
    timeout-minutes: 720
    env:
      BUILD_ID: ${{ needs.prepare.outputs.build_id }}
      PROJECT_PATH: ${{ github.workspace }}
      UNITY_PATH: ${{ vars.UNITY_WINDOWS_PATH || 'C:\Program Files\Unity\Hub\Editor\6000.0.58f2\Editor\Unity.exe' }}
      UNITY_ASSETS_PATH: ${{ vars.UNITY_ASSETS_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Assets' }}
      UNITY_PACKAGES_PATH: ${{ vars.UNITY_PACKAGES_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Packages' }}
      LOCALAPPDATA: ${{ github.workspace }}\.unity-cache\LocalAppData
      APPDATA: ${{ github.workspace }}\.unity-cache\AppData

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Restore Library cache
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $cacheLocation) {
            if (Test-Path $libraryPath) { Remove-Item -Recurse -Force $libraryPath }
            Copy-Item -Path $cacheLocation -Destination $libraryPath -Recurse -Force
            Write-Host "Library cache restored"
          }

      - name: Setup Unity cache directories
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheDir = "${{ github.workspace }}\.unity-cache"
          New-Item -ItemType Directory -Path "$cacheDir\LocalAppData\Unity\Caches" -Force | Out-Null
          New-Item -ItemType Directory -Path "$cacheDir\AppData\Unity" -Force | Out-Null

      - name: Setup Unity packages (Assets)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $assetsPath = "$env:UNITY_ASSETS_PATH"
          $packages = @(
            @{ Name = "Digger"; RelPath = "Digger" },
            @{ Name = "Samples"; RelPath = "Samples" },
            @{ Name = "NWH"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH" },
            @{ Name = "Silantro"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro" },
            @{ Name = "URPWater"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater" }
          )
          foreach ($pkg in $packages) {
            $sourcePath = Join-Path $assetsPath $pkg.RelPath
            $targetPath = Join-Path "$env:PROJECT_PATH\Assets" $pkg.RelPath
            if (Test-Path $sourcePath) {
              $targetParent = Split-Path $targetPath -Parent
              if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              if (Test-Path "$sourcePath.meta") { Copy-Item -Path "$sourcePath.meta" -Destination "$targetPath.meta" -Force }
            }
          }

      - name: Setup Vuplex WebGL
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $vuplexSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex-WebGL"
          $vuplexTarget = "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex"
          if (Test-Path $vuplexSource) {
            $targetParent = Split-Path $vuplexTarget -Parent
            if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
            if (Test-Path $vuplexTarget) { Remove-Item -Recurse -Force $vuplexTarget }
            if (Test-Path "$vuplexTarget.meta") { Remove-Item -Force "$vuplexTarget.meta" }
            New-Item -ItemType Directory -Path $vuplexTarget -Force | Out-Null
            Copy-Item -Path "$vuplexSource\*" -Destination $vuplexTarget -Recurse -Force
            $metaSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta"
            if (Test-Path $metaSource) { Copy-Item -Path $metaSource -Destination "$vuplexTarget.meta" -Force }
          } else { Write-Host "::error::Vuplex WebGL not found"; exit 1 }

      - name: Setup Unity packages (Embedded)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $packagesPath = "$env:UNITY_PACKAGES_PATH"
          $embeddedPackages = @("com.occasoftware.super-simple-skybox", "com.tivadar.best.http", "com.tivadar.best.mqtt", "com.tivadar.best.websockets")
          foreach ($pkg in $embeddedPackages) {
            $sourcePath = Join-Path $packagesPath $pkg
            $targetPath = Join-Path "$env:PROJECT_PATH\Packages" $pkg
            if (Test-Path $sourcePath) {
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
            }
          }

      - name: Create Logs directory
        shell: powershell -ExecutionPolicy Bypass {0}
        run: New-Item -ItemType Directory -Path "$env:PROJECT_PATH\Logs" -Force | Out-Null

      - name: Build WebGL Compressed
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $buildStart = Get-Date
          $logFile = "$env:PROJECT_PATH\Logs\build-webgl-compressed.log"
          $process = Start-Process -FilePath $env:UNITY_PATH -ArgumentList @("-batchmode", "-nographics", "-quit", "-projectPath", "$env:PROJECT_PATH", "-executeMethod", "FiveSQD.WebVerse.Building.Builder.BuildWebGLCompressed", "-logFile", $logFile) -Wait -PassThru -NoNewWindow
          Write-Host "Build duration: $((Get-Date) - $buildStart)"
          if (Test-Path $logFile) { Get-Content $logFile -Tail 50 }
          if ($process.ExitCode -ne 0) { Write-Host "::error::Build failed"; exit $process.ExitCode }

      - name: Create archive
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $artifactsDir = "$env:PROJECT_PATH\Artifacts"
          New-Item -ItemType Directory -Path $artifactsDir -Force | Out-Null
          $excludeFolders = @("*_BackUpThisFolder_ButDontShipItWithYourGame", "*_BurstDebugInformation_DoNotShip")
          if (Test-Path "$env:PROJECT_PATH\Builds\WebGL-Compressed") {
            foreach ($pattern in $excludeFolders) {
              Get-ChildItem "$env:PROJECT_PATH\Builds\WebGL-Compressed" -Directory -Filter $pattern -Recurse | ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
            }
            Compress-Archive -Path "$env:PROJECT_PATH\Builds\WebGL-Compressed\*" -DestinationPath "$artifactsDir\WebGL-Compressed-$env:BUILD_ID.zip"
          }

      - name: Upload to S3
        shell: powershell -ExecutionPolicy Bypass {0}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          $awsCli = "C:\Program Files\Amazon\AWSCLIV2\aws.exe"
          if (-not (Test-Path $awsCli)) {
            $awsCli = (Get-Command aws -ErrorAction SilentlyContinue).Source
            if (-not $awsCli) { Write-Host "::error::AWS CLI not found"; exit 1 }
          }
          $s3Path = "s3://$env:S3_BUCKET/builds/$env:BUILD_ID"
          Get-ChildItem "$env:PROJECT_PATH\Artifacts\*.zip" | ForEach-Object {
            & $awsCli s3 cp $_.FullName "$s3Path/$($_.Name)" --region $env:AWS_REGION
            Write-Host "https://$env:S3_BUCKET.s3.$env:AWS_REGION.amazonaws.com/builds/$env:BUILD_ID/$($_.Name)"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webgl-compressed-${{ needs.prepare.outputs.build_id }}
          path: ${{ github.workspace }}/Artifacts/*.zip
          retention-days: 30

      - name: Save Library cache
        if: success()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $libraryPath) {
            if (Test-Path $cacheLocation) { Remove-Item -Recurse -Force $cacheLocation }
            Copy-Item -Path $libraryPath -Destination $cacheLocation -Recurse -Force
          }

      - name: Cleanup
        if: always()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          Remove-Item -Path "$env:PROJECT_PATH\Builds" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Artifacts" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "${{ github.workspace }}\.unity-cache" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.occasoftware.super-simple-skybox" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.http" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.mqtt" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.websockets" -Recurse -Force -ErrorAction SilentlyContinue

  # WebGL Uncompressed build (runs after WebGL Compressed)
  build-webgl-uncompressed:
    needs: [prepare, build-webgl-compressed]
    if: ${{ always() && (github.event_name == 'push' || github.event.inputs.build_webgl_uncompressed == 'true') && (needs.build-webgl-compressed.result == 'success' || needs.build-webgl-compressed.result == 'skipped') }}
    runs-on: [self-hosted, Windows, unity]
    timeout-minutes: 720
    env:
      BUILD_ID: ${{ needs.prepare.outputs.build_id }}
      PROJECT_PATH: ${{ github.workspace }}
      UNITY_PATH: ${{ vars.UNITY_WINDOWS_PATH || 'C:\Program Files\Unity\Hub\Editor\6000.0.58f2\Editor\Unity.exe' }}
      UNITY_ASSETS_PATH: ${{ vars.UNITY_ASSETS_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Assets' }}
      UNITY_PACKAGES_PATH: ${{ vars.UNITY_PACKAGES_WINDOWS_PATH || 'C:\UnityAssets\WebVerse\Packages' }}
      LOCALAPPDATA: ${{ github.workspace }}\.unity-cache\LocalAppData
      APPDATA: ${{ github.workspace }}\.unity-cache\AppData

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Restore Library cache
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $cacheLocation) {
            if (Test-Path $libraryPath) { Remove-Item -Recurse -Force $libraryPath }
            Copy-Item -Path $cacheLocation -Destination $libraryPath -Recurse -Force
            Write-Host "Library cache restored"
          }

      - name: Setup Unity cache directories
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheDir = "${{ github.workspace }}\.unity-cache"
          New-Item -ItemType Directory -Path "$cacheDir\LocalAppData\Unity\Caches" -Force | Out-Null
          New-Item -ItemType Directory -Path "$cacheDir\AppData\Unity" -Force | Out-Null

      - name: Setup Unity packages (Assets)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $assetsPath = "$env:UNITY_ASSETS_PATH"
          $packages = @(
            @{ Name = "Digger"; RelPath = "Digger" },
            @{ Name = "Samples"; RelPath = "Samples" },
            @{ Name = "NWH"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH" },
            @{ Name = "Silantro"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro" },
            @{ Name = "URPWater"; RelPath = "Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater" }
          )
          foreach ($pkg in $packages) {
            $sourcePath = Join-Path $assetsPath $pkg.RelPath
            $targetPath = Join-Path "$env:PROJECT_PATH\Assets" $pkg.RelPath
            if (Test-Path $sourcePath) {
              $targetParent = Split-Path $targetPath -Parent
              if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
              if (Test-Path "$sourcePath.meta") { Copy-Item -Path "$sourcePath.meta" -Destination "$targetPath.meta" -Force }
            }
          }

      - name: Setup Vuplex WebGL
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $vuplexSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex-WebGL"
          $vuplexTarget = "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex"
          if (Test-Path $vuplexSource) {
            $targetParent = Split-Path $vuplexTarget -Parent
            if (-not (Test-Path $targetParent)) { New-Item -ItemType Directory -Path $targetParent -Force | Out-Null }
            if (Test-Path $vuplexTarget) { Remove-Item -Recurse -Force $vuplexTarget }
            if (Test-Path "$vuplexTarget.meta") { Remove-Item -Force "$vuplexTarget.meta" }
            New-Item -ItemType Directory -Path $vuplexTarget -Force | Out-Null
            Copy-Item -Path "$vuplexSource\*" -Destination $vuplexTarget -Recurse -Force
            $metaSource = Join-Path "$env:UNITY_ASSETS_PATH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta"
            if (Test-Path $metaSource) { Copy-Item -Path $metaSource -Destination "$vuplexTarget.meta" -Force }
          } else { Write-Host "::error::Vuplex WebGL not found"; exit 1 }

      - name: Setup Unity packages (Embedded)
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $packagesPath = "$env:UNITY_PACKAGES_PATH"
          $embeddedPackages = @("com.occasoftware.super-simple-skybox", "com.tivadar.best.http", "com.tivadar.best.mqtt", "com.tivadar.best.websockets")
          foreach ($pkg in $embeddedPackages) {
            $sourcePath = Join-Path $packagesPath $pkg
            $targetPath = Join-Path "$env:PROJECT_PATH\Packages" $pkg
            if (Test-Path $sourcePath) {
              if (Test-Path $targetPath) { Remove-Item -Recurse -Force $targetPath }
              New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              Copy-Item -Path "$sourcePath\*" -Destination $targetPath -Recurse -Force
            }
          }

      - name: Create Logs directory
        shell: powershell -ExecutionPolicy Bypass {0}
        run: New-Item -ItemType Directory -Path "$env:PROJECT_PATH\Logs" -Force | Out-Null

      - name: Build WebGL Uncompressed
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $buildStart = Get-Date
          $logFile = "$env:PROJECT_PATH\Logs\build-webgl-uncompressed.log"
          $process = Start-Process -FilePath $env:UNITY_PATH -ArgumentList @("-batchmode", "-nographics", "-quit", "-projectPath", "$env:PROJECT_PATH", "-executeMethod", "FiveSQD.WebVerse.Building.Builder.BuildWebGLUncompressed", "-logFile", $logFile) -Wait -PassThru -NoNewWindow
          Write-Host "Build duration: $((Get-Date) - $buildStart)"
          if (Test-Path $logFile) { Get-Content $logFile -Tail 50 }
          if ($process.ExitCode -ne 0) { Write-Host "::error::Build failed"; exit $process.ExitCode }

      - name: Create archive
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $artifactsDir = "$env:PROJECT_PATH\Artifacts"
          New-Item -ItemType Directory -Path $artifactsDir -Force | Out-Null
          $excludeFolders = @("*_BackUpThisFolder_ButDontShipItWithYourGame", "*_BurstDebugInformation_DoNotShip")
          if (Test-Path "$env:PROJECT_PATH\Builds\WebGL-Uncompressed") {
            foreach ($pattern in $excludeFolders) {
              Get-ChildItem "$env:PROJECT_PATH\Builds\WebGL-Uncompressed" -Directory -Filter $pattern -Recurse | ForEach-Object { Remove-Item -Recurse -Force $_.FullName }
            }
            Compress-Archive -Path "$env:PROJECT_PATH\Builds\WebGL-Uncompressed\*" -DestinationPath "$artifactsDir\WebGL-Uncompressed-$env:BUILD_ID.zip"
          }

      - name: Upload to S3
        shell: powershell -ExecutionPolicy Bypass {0}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          $awsCli = "C:\Program Files\Amazon\AWSCLIV2\aws.exe"
          if (-not (Test-Path $awsCli)) {
            $awsCli = (Get-Command aws -ErrorAction SilentlyContinue).Source
            if (-not $awsCli) { Write-Host "::error::AWS CLI not found"; exit 1 }
          }
          $s3Path = "s3://$env:S3_BUCKET/builds/$env:BUILD_ID"
          Get-ChildItem "$env:PROJECT_PATH\Artifacts\*.zip" | ForEach-Object {
            & $awsCli s3 cp $_.FullName "$s3Path/$($_.Name)" --region $env:AWS_REGION
            Write-Host "https://$env:S3_BUCKET.s3.$env:AWS_REGION.amazonaws.com/builds/$env:BUILD_ID/$($_.Name)"
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: webgl-uncompressed-${{ needs.prepare.outputs.build_id }}
          path: ${{ github.workspace }}/Artifacts/*.zip
          retention-days: 30

      - name: Save Library cache
        if: success()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          $cacheLocation = "C:\UnityLibraryCache\WebVerse-Runtime"
          $libraryPath = "$env:PROJECT_PATH\Library"
          if (Test-Path $libraryPath) {
            if (Test-Path $cacheLocation) { Remove-Item -Recurse -Force $cacheLocation }
            Copy-Item -Path $libraryPath -Destination $cacheLocation -Recurse -Force
          }

      - name: Cleanup
        if: always()
        shell: powershell -ExecutionPolicy Bypass {0}
        run: |
          Remove-Item -Path "$env:PROJECT_PATH\Builds" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Artifacts" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "${{ github.workspace }}\.unity-cache" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Digger.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Samples.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\NWH.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Silantro.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\URPWater.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Assets\Runtime\StraightFour\Assets\StraightFour\3rd-party\Vuplex.meta" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.occasoftware.super-simple-skybox" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.http" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.mqtt" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "$env:PROJECT_PATH\Packages\com.tivadar.best.websockets" -Recurse -Force -ErrorAction SilentlyContinue

  # Mac Desktop build (runs in parallel with Windows jobs)
  build-mac:
    needs: prepare
    runs-on: [self-hosted, macOS, unity]
    timeout-minutes: 720
    if: ${{ github.event_name == 'push' || github.event.inputs.build_mac == 'true' }}
    env:
      BUILD_ID: ${{ needs.prepare.outputs.build_id }}
      PROJECT_PATH: ${{ github.workspace }}
      UNITY_PATH: ${{ vars.UNITY_MAC_PATH || '/Applications/Unity/Hub/Editor/6000.0.58f2-arm64/Unity.app/Contents/MacOS/Unity' }}
      UNITY_ASSETS_PATH: ${{ vars.UNITY_ASSETS_MAC_PATH || '/Users/Shared/UnityAssets/WebVerse/Assets' }}
      UNITY_PACKAGES_PATH: ${{ vars.UNITY_PACKAGES_MAC_PATH || '/Users/Shared/UnityAssets/WebVerse/Packages' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          submodules: recursive

      - name: Restore Library cache
        run: |
          CACHE_LOCATION="/Users/Shared/UnityLibraryCache/WebVerse-Runtime"
          LIBRARY_PATH="$PROJECT_PATH/Library"
          if [ -d "$CACHE_LOCATION" ]; then
            rm -rf "$LIBRARY_PATH" 2>/dev/null || true
            cp -R "$CACHE_LOCATION" "$LIBRARY_PATH"
            echo "Library cache restored"
          fi

      - name: Setup Unity packages (Assets)
        run: |
          ASSETS_PATH="$UNITY_ASSETS_PATH"
          copy_package() {
            local name="$1"; local rel_path="$2"
            local source_path="$ASSETS_PATH/$rel_path"
            local target_path="$PROJECT_PATH/Assets/$rel_path"
            if [ -d "$source_path" ]; then
              mkdir -p "$(dirname "$target_path")"
              rm -rf "$target_path" 2>/dev/null || true
              if command -v ditto &> /dev/null; then ditto "$source_path" "$target_path"; else cp -R "$source_path" "$target_path"; fi
              [ -f "$source_path.meta" ] && cp "$source_path.meta" "$target_path.meta"
              echo "Copied $name"
            fi
          }
          copy_package "Digger" "Digger"
          copy_package "Samples" "Samples"
          copy_package "NWH" "Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH"
          copy_package "Silantro" "Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro"
          copy_package "URPWater" "Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater"
          
          # Vuplex Desktop
          VUPLEX_SOURCE="$ASSETS_PATH/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex-Desktop"
          VUPLEX_TARGET="$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex"
          if [ -d "$VUPLEX_SOURCE" ]; then
            mkdir -p "$(dirname "$VUPLEX_TARGET")"
            rm -rf "$VUPLEX_TARGET" "$VUPLEX_TARGET.meta" 2>/dev/null || true
            if command -v ditto &> /dev/null; then ditto "$VUPLEX_SOURCE" "$VUPLEX_TARGET"; else cp -R "$VUPLEX_SOURCE" "$VUPLEX_TARGET"; fi
            [ -f "$ASSETS_PATH/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta" ] && cp "$ASSETS_PATH/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta" "$VUPLEX_TARGET.meta"
          fi

      - name: Setup Unity packages (Embedded)
        run: |
          PACKAGES_PATH="$UNITY_PACKAGES_PATH"
          for pkg in "com.occasoftware.super-simple-skybox" "com.tivadar.best.http" "com.tivadar.best.mqtt" "com.tivadar.best.websockets"; do
            source_path="$PACKAGES_PATH/$pkg"
            target_path="$PROJECT_PATH/Packages/$pkg"
            if [ -d "$source_path" ]; then
              rm -rf "$target_path" 2>/dev/null || true
              if command -v ditto &> /dev/null; then ditto "$source_path" "$target_path"; else cp -R "$source_path" "$target_path"; fi
            fi
          done

      - name: Create Logs directory
        run: mkdir -p "$PROJECT_PATH/Logs"

      - name: Build Mac Desktop
        run: |
          set +e
          "$UNITY_PATH" -batchmode -nographics -quit -projectPath "$PROJECT_PATH" -executeMethod FiveSQD.WebVerse.Building.Builder.BuildMacDesktop -logFile "$PROJECT_PATH/Logs/build-mac.log"
          EXIT_CODE=$?
          set -e
          echo "Unity exit code: $EXIT_CODE"
          if [ -f "$PROJECT_PATH/Logs/build-mac.log" ]; then
            echo "=== Last 100 lines of build log ==="
            tail -100 "$PROJECT_PATH/Logs/build-mac.log"
          fi
          # Check for success indicators in log
          if [ -f "$PROJECT_PATH/Logs/build-mac.log" ]; then
            if grep -q "Exiting batchmode successfully" "$PROJECT_PATH/Logs/build-mac.log"; then
              echo "Build completed successfully (found success message in log)"
              EXIT_CODE=0
            fi
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::Unity build failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Create archive
        run: |
          mkdir -p "$PROJECT_PATH/Artifacts"
          if [ -d "$PROJECT_PATH/Builds/Mac-Desktop" ]; then
            cd "$PROJECT_PATH/Builds/Mac-Desktop"
            find . -type d -name "*_BackUpThisFolder_ButDontShipItWithYourGame" -exec rm -rf {} + 2>/dev/null || true
            find . -type d -name "*_BurstDebugInformation_DoNotShip" -exec rm -rf {} + 2>/dev/null || true
            zip -r "$PROJECT_PATH/Artifacts/Mac-Desktop-$BUILD_ID.zip" .
          fi

      - name: Upload to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: us-east-1
        run: |
          export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"
          S3_PATH="s3://$S3_BUCKET/builds/$BUILD_ID"
          for artifact in $PROJECT_PATH/Artifacts/*.zip; do
            [ -f "$artifact" ] && aws s3 cp "$artifact" "$S3_PATH/$(basename "$artifact")" --region $AWS_REGION
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mac-builds-${{ needs.prepare.outputs.build_id }}
          path: ${{ github.workspace }}/Artifacts/*.zip
          retention-days: 30

      - name: Save Library cache
        if: success()
        run: |
          CACHE_LOCATION="/Users/Shared/UnityLibraryCache/WebVerse-Runtime"
          [ -d "$PROJECT_PATH/Library" ] && rsync -a --delete "$PROJECT_PATH/Library/" "$CACHE_LOCATION/"

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$PROJECT_PATH/Builds" "$PROJECT_PATH/Artifacts" || true
          rm -rf "$PROJECT_PATH/Assets/Digger" "$PROJECT_PATH/Assets/Digger.meta" || true
          rm -rf "$PROJECT_PATH/Assets/Samples" "$PROJECT_PATH/Assets/Samples.meta" || true
          rm -rf "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH" "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/NWH.meta" || true
          rm -rf "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro" "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/Silantro.meta" || true
          rm -rf "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater" "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/URPWater.meta" || true
          rm -rf "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex" "$PROJECT_PATH/Assets/Runtime/StraightFour/Assets/StraightFour/3rd-party/Vuplex.meta" || true
          rm -rf "$PROJECT_PATH/Packages/com.occasoftware.super-simple-skybox" "$PROJECT_PATH/Packages/com.tivadar.best.http" "$PROJECT_PATH/Packages/com.tivadar.best.mqtt" "$PROJECT_PATH/Packages/com.tivadar.best.websockets" || true

  # Summary job
  summary:
    needs: [prepare, build-windows-desktop, build-webgl-compressed, build-webgl-uncompressed, build-mac]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID:** ${{ needs.prepare.outputs.build_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Windows Desktop | ${{ needs.build-windows-desktop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WebGL Compressed | ${{ needs.build-webgl-compressed.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| WebGL Uncompressed | ${{ needs.build-webgl-uncompressed.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Mac Desktop | ${{ needs.build-mac.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### S3 URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: \`https://${{ env.S3_BUCKET }}.s3.${{ env.AWS_REGION }}.amazonaws.com/builds/${{ needs.prepare.outputs.build_id }}/Windows-Desktop-${{ needs.prepare.outputs.build_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- Mac: \`https://${{ env.S3_BUCKET }}.s3.${{ env.AWS_REGION }}.amazonaws.com/builds/${{ needs.prepare.outputs.build_id }}/Mac-Desktop-${{ needs.prepare.outputs.build_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- WebGL Compressed: \`https://${{ env.S3_BUCKET }}.s3.${{ env.AWS_REGION }}.amazonaws.com/builds/${{ needs.prepare.outputs.build_id }}/WebGL-Compressed-${{ needs.prepare.outputs.build_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "- WebGL Uncompressed: \`https://${{ env.S3_BUCKET }}.s3.${{ env.AWS_REGION }}.amazonaws.com/builds/${{ needs.prepare.outputs.build_id }}/WebGL-Uncompressed-${{ needs.prepare.outputs.build_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
